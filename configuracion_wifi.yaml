# configuracion_wifi.yaml
# Uso: packages: wifi: !include configuracion_wifi.yaml
# Requiere: friendly_name; secrets: wifi_ssid, wifi_password, ap_ssid, ap_password, admin
# Un script periódico actualiza WiFi, API y el sensor estado_conexion.


# --- Constantes (editar aquí para cambiar valores por defecto del sistema) ---
umbral_contadores: 20 # Número máximo de intentos sin WiFi y sin API
intervalo_chequeo: 15s # Intervalo (en segundos) para chequeo del estado de red (WiFi/AP I)

wifi:
  power_save_mode: none
  networks:
    - ssid: !secret wifi_ssid
      password: !secret wifi_password
    - ssid: !secret ap_ssid
      password: !secret ap_password
  ap:
    password: !secret admin
    ap_timeout: 0s
    # IP fija del AP para conexiones más estables (ajusta a tu red si hace falta)
    manual_ip:
      static_ip: 192.168.4.1
      gateway: 192.168.4.1
      subnet: 255.255.255.0



# Eventos para avisos en HA: en HA crear automatización con disparador
# "Dispositivo ESP → evento aviso_estado_conexion" (estado_no_api o estado_modo_ap) → notificar
event:
  - platform: template
    name: "${friendly_name} Aviso estado conexión"
    id: aviso_estado_conexion
    event_types:
      - estado_no_api
      - estado_modo_ap

interval:
  - interval: ${intervalo_chequeo}
    then:
      - script.execute: chequeo_estado

globals:
  - id: intentos_sin_wifi
    type: int
    restore_value: false
    initial_value: "0"

  - id: intentos_sin_api
    type: int
    restore_value: false
    initial_value: "0"

  - id: intentos_en_modo_ap
    type: int
    restore_value: false
    initial_value: "0"
  - id: aviso_no_api_ya_enviado
    type: bool
    restore_value: false
    initial_value: "false"
  - id: aviso_modo_ap_ya_enviado
    type: bool
    restore_value: false
    initial_value: "false"

script:
  - id: chequeo_estado
    mode: single
    then:
      # --- WiFi: contador y modo_sin_conexion ---
      - if:
          condition:
            not:
              wifi.connected:
          then:
            - lambda: "id(intentos_sin_wifi)++;"
            - binary_sensor.template.publish: { id: modo_sin_conexion, state: ON }
          else:
            - lambda: "id(intentos_sin_wifi) = 0;"
            - binary_sensor.template.publish: { id: modo_sin_conexion, state: OFF }

      # --- Forzar AP si muchos intentos sin WiFi ---
      - if:
          condition: lambda: "return id(intentos_sin_wifi) >= ${umbral_contadores};"
          then:
            - wifi.enable_ap

      # --- Modo AP (punto de acceso activo) ---
      - if:
          condition: wifi.ap_active
          then:
            - binary_sensor.template.publish: { id: modo_ap, state: ON }
          else:
            - binary_sensor.template.publish: { id: modo_ap, state: OFF }

      # --- API: contador y api_conectada ---
      - if:
          condition: wifi.connected
          then:
            - if:
                condition: api.connected
                then:
                  - lambda: "id(intentos_sin_api) = 0;"
                  - binary_sensor.template.publish: { id: api_conectada, state: ON }
                else:
                  - lambda: "id(intentos_sin_api)++;"
                  - binary_sensor.template.publish: { id: api_conectada, state: OFF }

      # --- Estado global (un solo texto) y avisos a HA ---
      - if:
          condition: wifi.ap_active
          then:
            - text_sensor.template.publish: { id: estado_conexion, state: "Modo AP" }
            - lambda: "id(intentos_en_modo_ap) = 0;"
            # Aviso a HA solo al pasar a Modo AP (una vez)
            - if:
                condition: lambda: "return !id(aviso_modo_ap_ya_enviado);"
                then:
                  - lambda: "id(aviso_modo_ap_ya_enviado) = true;"
                  - event.trigger:
                      id: aviso_estado_conexion
                      event_type: estado_modo_ap
            - if:
                condition:
                  lambda: "return id(intentos_en_modo_ap) >= 20;"
                then:
                  - logger.log: "En modo AP: 20 o más intentos acumulados, intentando reconectar WiFi."
                  - wifi.connect
                  - lambda: "id(intentos_en_modo_ap) = 0;"
          else:
            - lambda: "id(aviso_modo_ap_ya_enviado) = false;"
            - if:
                condition: wifi.connected
                then:
                  - if:
                      condition: api.connected
                      then:
                        - text_sensor.template.publish: { id: estado_conexion, state: "Conectado" }
                        - lambda: "id(aviso_no_api_ya_enviado) = false;"
                      else:
                        - text_sensor.template.publish: { id: estado_conexion, state: "No API" }
                        # Aviso a HA solo al pasar a No API (una vez)
                        - if:
                            condition: lambda: "return !id(aviso_no_api_ya_enviado);"
                            then:
                              - lambda: "id(aviso_no_api_ya_enviado) = true;"
                              - event.trigger:
                                  id: aviso_estado_conexion
                                  event_type: estado_no_api
                else:
                  - text_sensor.template.publish: { id: estado_conexion, state: "Sin conexión" }
                  - lambda: "id(aviso_no_api_ya_enviado) = false;"


      # --- Reinicio si WiFi OK pero API sin conectar muchos intentos ---
      - if:
          condition:
            - wifi.connected
            - lambda: "return id(intentos_sin_api) >= ${umbral_contadores};"
          then:
            - logger.log: "API sin conexión (>= ${umbral_contadores} intentos). Reiniciando."
            - restart


# --- Sensores ---
binary_sensor:
  - platform: template
    name: "${friendly_name} Modo sin conexión"
    id: modo_sin_conexion
    device_class: connectivity
  - platform: template
    name: "${friendly_name} Modo AP"
    id: modo_ap
    device_class: connectivity
  - platform: template
    name: "${friendly_name} API conectada"
    id: api_conectada
    device_class: connectivity

text_sensor:
  # Info WiFi
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP"
    ssid:
      name: "${friendly_name} WiFi SSID"
    bssid:
      name: "${friendly_name} WiFi BSSID"
    mac_address:
      name: "${friendly_name} MAC"

  - platform: template
    name: "${friendly_name} Estado conexión"
    id: estado_conexion

sensor:
    # Intensidad de señal WiFi (RSSI)
  - platform: wifi_signal
    name: "${friendly_name} Señal WiFi"
    id: wifi_rssi
    update_interval: 60s

  - platform: template
    name: "${friendly_name} Intentos sin WiFi"
    id: intentos_sin_wifi_sensor
    unit_of_measurement: "intentos"
    accuracy_decimals: 0
  - platform: template
    name: "${friendly_name} Intentos sin API"
    id: intentos_sin_api_sensor
    unit_of_measurement: "intentos"
    accuracy_decimals: 0


button:
  - platform: template
    name: "${friendly_name} Desconectar WiFi"
    icon: "mdi:wifi-off"
    on_press:
      then:
        - wifi.disconnect:
  - platform: template
    name: "${friendly_name} Reconectar WiFi"
    icon: "mdi:wifi-refresh"
    on_press:
      then:
        - wifi.reconnect: